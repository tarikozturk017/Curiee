import { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { atom, useAtom } from 'jotai';
const jwt = require('jsonwebtoken');

import Head from 'next/head'
import SideBar from "./SideBar";
import Navbar from './Navbar';
import Footer from "./Footer";
import ProfileBar from './therapist/ProfileBar';

// create the atom
const userIdAtom = atom('');
const userTypeAtom = atom('');
const userTokenAtom = atom('');

const protectedRoutes = ['/patients'];
const patientsOnlyRoutes = ['/patients'];

const Layout = (props) => {
  const [userId, setUserId] = useAtom(userIdAtom);
  const [userType, setUserType] = useAtom(userTypeAtom);
  const [userToken, seUserToken] = useAtom(userTokenAtom);
  const router = useRouter();

  useEffect(() => {
    if(userToken !== '') {
      try {
        const decodedToken = jwt.decode(userToken);
        let patientId;
        if(decodedToken){
          patientId = decodedToken.patientId;

          if (patientId) {
            setUserId(patientId);
            setUserType('patient');       
          } else {
            const therapistId = decodedToken.therapistId
            setUserId(therapistId);
            setUserType('therapist');
          }
        } 
      } catch (error) {
        console.log(error)
      }
    }
  }, [userToken]);

  useEffect(() => {
    const token = localStorage.getItem('token');
    // console.log(`token: ${token}`)
    seUserToken(token)
    if (!token && protectedRoutes.includes(router.pathname)) {
      console.log('not logged in')
      router.push('/login');
    }
    if (userType != 'therapist' && patientsOnlyRoutes.includes(router.pathname)) {
      console.log('only patients can see')
      router.push('/');
    }
  }, []);

  useEffect(() => {
    const token = localStorage.getItem('token');
    if (!token && protectedRoutes.includes(router.pathname)) {
      console.log('not logged in')
      router.push('/login');
    }
    if (userType != 'therapist' && patientsOnlyRoutes.includes(router.pathname)) {
      console.log('only patients can see')
      router.push('/');
    }
  }, [router]);

    return (
        <>
            <Head>
                <title>Patient Management System</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <div className=" h-screen bg-gradient-to-tr from-violet-200 to-violet-400">
            <Navbar />
            {/* if user logged in, display sidebar */}
            {userToken && <SideBar />}
            <ProfileBar />
                {props.children}
            </div>
            <Footer />
        </>
    )
}

export default Layout;
export { userIdAtom, userTypeAtom, userTokenAtom };